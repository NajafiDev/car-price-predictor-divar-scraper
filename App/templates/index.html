{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card">
            <div class="card-header text-center bg-primary text-white py-4">
                <h1 class="h3 mb-0">ğŸš— Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‚ÛŒÙ…Øª Ø®ÙˆØ¯Ø±Ùˆ</h1>
                <p class="mb-0 opacity-75">Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ø¯ÛŒÙˆØ§Ø±</p>
            </div>
            
            <div class="card-body p-4">
                <!-- Step Indicators -->
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <small>Ù…Ø´Ø®ØµØ§Øª Ø®ÙˆØ¯Ø±Ùˆ</small>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <small>Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</small>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <small>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</small>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <small>Ø¢Ù…ÙˆØ²Ø´ Ù…Ø¯Ù„</small>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-circle">5</div>
                        <small>Ù†ØªÛŒØ¬Ù‡</small>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Step 1: Car Specifications Form -->
                <div id="step1-content">
                    <form id="carForm">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Ø¨Ø±Ù†Ø¯ Ùˆ Ù…Ø¯Ù„ Ø®ÙˆØ¯Ø±Ùˆ</label>
                                <input type="text" class="form-control" name="brand_model" 
                                       placeholder="Ù…Ø«Ø§Ù„: Ù¾Ú˜Ùˆ 206 ØªÛŒÙ¾ Û²" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Ø³Ø§Ù„ Ø³Ø§Ø®Øª</label>
                                <input type="number" class="form-control" name="year_model" 
                                       min="1350" max="1410" placeholder="Ù…Ø«Ø§Ù„: 1400" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Ú©Ø§Ø±Ú©Ø±Ø¯ (Ú©ÛŒÙ„ÙˆÙ…ØªØ±)</label>
                                <input type="number" class="form-control" name="mileage" 
                                       placeholder="Ù…Ø«Ø§Ù„: 80000" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Ú¯ÛŒØ±Ø¨Ú©Ø³</label>
                                <select class="form-select" name="gearbox" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                    <option value="Ø¯Ù†Ø¯Ù‡ Ø§ÛŒ">Ø¯Ù†Ø¯Ù‡ Ø§ÛŒ</option>
                                    <option value="Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©">Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Ù†ÙˆØ¹ Ø³ÙˆØ®Øª</label>
                                <select class="form-select" name="fuel_type" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                                    <option value="Ø¨Ù†Ø²ÛŒÙ†">Ø¨Ù†Ø²ÛŒÙ†</option>
                                    <option value="Ø¯ÙˆÚ¯Ø§Ù†Ù‡â€ŒØ³ÙˆØ² Ø´Ø±Ú©ØªÛŒ">Ø¯ÙˆÚ¯Ø§Ù†Ù‡â€ŒØ³ÙˆØ² Ø´Ø±Ú©ØªÛŒ</option>
                                    <option value="Ø¯ÙˆÚ¯Ø§Ù†Ù‡â€ŒØ³ÙˆØ² Ø¯Ø³ØªÛŒ">Ø¯ÙˆÚ¯Ø§Ù†Ù‡â€ŒØ³ÙˆØ² Ø¯Ø³ØªÛŒ</option>
                                    <option value="Ø¨Ø±Ù‚ÛŒ">Ø¨Ø±Ù‚ÛŒ</option>
                                    <option value="Ù‡ÛŒØ¨Ø±ÛŒØ¯">Ù‡ÛŒØ¨Ø±ÛŒØ¯</option>
                                    <option value="Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„">Ú¯Ø§Ø²ÙˆØ¦ÛŒÙ„</option>
                                    <option value="Ù¾Ù„Ø§Ú¯ÛŒÙ† Ù‡ÛŒØ¨Ø±ÛŒØ¯">Ù¾Ù„Ø§Ú¯ÛŒÙ† Ù‡ÛŒØ¨Ø±ÛŒØ¯</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary w-100 py-3">
                                <i class="bi bi-calculator me-2"></i>
                                Ø´Ø±ÙˆØ¹ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‚ÛŒÙ…Øª
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Step 2-4: Progress Content -->
                <div id="progress-content" style="display: none;">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                        </div>
                        <h5 id="progress-title" class="mb-2">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</h5>
                        <p id="progress-message" class="text-muted">Ù„Ø·ÙØ§ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯</p>
                        <div class="mt-3">
                            <span id="progress-details" class="badge bg-secondary"></span>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Results -->
                <div id="results-content" style="display: none;">
                    <div class="text-center py-4">
                        <div class="mb-4">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        </div>
                        <h4 class="text-success mb-3">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‚ÛŒÙ…Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!</h4>
                        
                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <h2 id="predicted-price" class="text-primary mb-0"></h2>
                                <small class="text-muted">Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø´Ø¯Ù‡</small>
                            </div>
                        </div>
                        
                        <div class="row text-start mb-4">
                            <div class="col-6">
                                <small class="text-muted">Ø¨Ø±Ù†Ø¯ Ùˆ Ù…Ø¯Ù„</small>
                                <p id="result-brand" class="mb-2 fw-bold"></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Ø³Ø§Ù„ Ø³Ø§Ø®Øª</small>
                                <p id="result-year" class="mb-2 fw-bold"></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Ú©Ø§Ø±Ú©Ø±Ø¯</small>
                                <p id="result-mileage" class="mb-2 fw-bold"></p>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Ú¯ÛŒØ±Ø¨Ú©Ø³</small>
                                <p id="result-gearbox" class="mb-2 fw-bold"></p>
                            </div>
                        </div>
                        
                        <button onclick="location.reload()" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-repeat me-2"></i>
                            Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¬Ø¯ÛŒØ¯
                        </button>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="error-message" class="alert alert-danger mt-3" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="error-text"></span>
                </div>
            </div>
        </div>
        
        <!-- Info Card -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">ğŸ“Š Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø§ÛŒÙ† Ø³Ø±ÙˆÛŒØ³</h6>
                <p class="card-text small mb-2">
                    Ø§ÛŒÙ† Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ø³Ø§ÛŒØª Ø¯ÛŒÙˆØ§Ø± Ùˆ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ 
                    ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø§Ø´ÛŒÙ†ØŒ Ù‚ÛŒÙ…Øª Ø®ÙˆØ¯Ø±ÙˆÛŒ Ø´Ù…Ø§ Ø±Ø§ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                </p>
                <ul class="small text-muted mb-0">
                    <li>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÙˆØ§Ø± Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</li>
                    <li>Ù…Ø¯Ù„ ML Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ø®ØªØµØ§ØµÛŒ Ø¢Ù…ÙˆØ²Ø´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</li>
                    <li>Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø§Ø²Ø§Ø± ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯Ø±Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Progress tracking
let currentStep = 1;

function updateProgress(step, message = '') {
    // Update step indicators
    document.querySelectorAll('.step').forEach((s, index) => {
        if (index + 1 < step) {
            s.classList.add('completed');
            s.classList.remove('active');
        } else if (index + 1 === step) {
            s.classList.add('active');
            s.classList.remove('completed');
        } else {
            s.classList.remove('active', 'completed');
        }
    });
    
    // Update progress bar
    const progress = ((step - 1) / 4) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;
    
    // Update progress message
    if (message) {
        document.getElementById('progress-message').textContent = message;
    }
}

// Form submission
document.getElementById('carForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...';
    
    try {
        // Step 1: Submit form data
        const response = await fetch('/predict', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Hide form, show progress
            document.getElementById('step1-content').style.display = 'none';
            document.getElementById('progress-content').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            
            // Start the pipeline
            await runPipeline();
        } else {
            throw new Error(data.error);
        }
        
    } catch (error) {
        showError(error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-calculator me-2"></i>Ø´Ø±ÙˆØ¹ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‚ÛŒÙ…Øª';
    }
});

async function runPipeline() {
    try {
        // Step 2: Search for ads
        updateProgress(2, 'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡ Ø¯Ø± Ø¯ÛŒÙˆØ§Ø±...');
        let response = await fetch('/search_ads');
        let data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        document.getElementById('progress-details').textContent = `${data.urls_count} Ø¢Ú¯Ù‡ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯`;
        
        // Step 3: Scrape data
        updateProgress(3, 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§...');
        response = await fetch('/scrape_data');
        data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        document.getElementById('progress-details').textContent = `${data.ads_count} Ø¢Ú¯Ù‡ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯`;
        
        // Step 4: Train model
        updateProgress(4, 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…ÙˆØ²Ø´ Ù…Ø¯Ù„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...');
        response = await fetch('/train_model');
        data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        document.getElementById('progress-details').textContent = `Ù…Ø¯Ù„ Ø¨Ø§ ${data.samples_count} Ø¯Ø§Ø¯Ù‡ Ø¢Ù…ÙˆØ²Ø´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯`;
        
        // Step 5: Get prediction
        updateProgress(5, 'Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‚ÛŒÙ…Øª...');
        response = await fetch('/get_prediction');
        data = await response.json();
        
        if (!data.success) throw new Error(data.error);
        
        // Show results
        showResults(data);
        
    } catch (error) {
        showError(error.message);
    }
}

function showResults(data) {
    document.getElementById('progress-content').style.display = 'none';
    document.getElementById('results-content').style.display = 'block';
    
    // Update results
    document.getElementById('predicted-price').textContent = data.formatted_price + ' ØªÙˆÙ…Ø§Ù†';
    document.getElementById('result-brand').textContent = data.car_info.brand_model;
    document.getElementById('result-year').textContent = data.car_info.year_model;
    document.getElementById('result-mileage').textContent = data.car_info.mileage.toLocaleString() + ' Ú©ÛŒÙ„ÙˆÙ…ØªØ±';
    document.getElementById('result-gearbox').textContent = data.car_info.gearbox;
    
    updateProgress(5);
}

function showError(message) {
    document.getElementById('error-text').textContent = message;
    document.getElementById('error-message').style.display = 'block';
    
    // Show form again
    document.getElementById('step1-content').style.display = 'block';
    document.getElementById('progress-content').style.display = 'none';
    document.getElementById('results-content').style.display = 'none';
    
    // Reset form button
    const submitBtn = document.querySelector('#carForm button[type="submit"]');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="bi bi-calculator me-2"></i>Ø´Ø±ÙˆØ¹ Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù‚ÛŒÙ…Øª';
    
    updateProgress(1);
}
</script>
{% endblock %}